<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>JAVA套接字之TCP实现聊天室 | Frey's blog</title><link rel="stylesheet" type="text/css" href="/css/style.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.png"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script></head><script src="https://www.googletagmanager.com/gtag/js?id=UA-111205240-3" async></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-111205240-3');
</script><script src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js" async></script><script>(adsbygoogle = window.adsbygoogle || []).push({
  google_ad_client: "ca-pub-3597458182538053",
  enable_page_level_ads: true
});</script><script custom-element="amp-ad" src="https://cdn.ampproject.org/v0/amp-ad-0.1.js" async></script><link rel="stylesheet" type="text/css" href="/plugins/prettify/doxy.css"><script type="text/javascript" src="/js/ready.js" async></script><body><div class="mobile-head" id="mobile-head"><div class="navbar-icon"><span></span><span></span><span></span></div><div class="navbar-title"><a href="/">Frey's blog</a></div><div class="navbar-search"><!--= show a circle here--></div></div><div class="h-wrapper" id="menu"><nav class="h-head box"><div class="m-hdimg"><a class="hdimg img" href="/"><img class="nofancybox" src="/img/profile.jpg" width="128" height="128"></a><h1 class="ttl"><a href="/">Frey's blog</a></h1></div><p class="m-desc">空悲眼界高，敢怨人间小。<br>越不爱人间，越觉人间好。</p><div class="m-nav"><ul><li><span class="dot">●</span><a href="/archives/">归档</a></li><li><span class="dot">●</span><a href="/categories/">分类</a></li><li><span class="dot">●</span><a href="/tags/">标签</a></li><li><span class="dot">●</span><a href="/about/">关于</a></li><li><span class="dot">●</span><a href="/atom.xml">RSS</a></li><li class="m-sch"><form class="form" id="j-formsch" action="/search" method="get"><input class="txt" type="text" id="local-search-input" name="q" value="搜索" onfocus="if(this.value=='搜索'){this.value='';}" onblur="if(this.value==''){this.value='搜索';}"></form></li></ul><div id="local-search-result"></div></div><amp-ad width="100vw" height="320" type="adsense" data-ad-client="ca-pub-3597458182538053" data-ad-slot="7295042689" data-auto-format="rspv" data-full-width><div overflow></div></amp-ad></nav></div><div id="back2Top"><a class="fa fa-arrow-up" title="Back to top" href="#"></a></div><div class="box" id="container"><div class="l-wrapper"><div class="l-content box"><div class="l-post l-post-art"><article class="p-art"><div class="p-header box"><h1 class="p-title">JAVA套接字之TCP实现聊天室</h1><div class="p-info"><span class="p-date"><i class="fa fa-calendar"></i><a href="/2017/JAVA套接字之TCP实现聊天室/">2017-08-10</a></span><span class="p-category"><i class="fa fa-folder"></i><a href="/categories/编程/">编程</a>&nbsp;&bull;&nbsp;<a href="/categories/编程/Java/">Java</a></span><span class="p-view" id="busuanzi_container_page_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_page_pv"></span></span></div></div><div class="p-content"><p>java实现聊天室,通过多线程实现随时加入,随时退出</p>
<h3 id="1-客户端程序"><a href="#1-客户端程序" class="headerlink" title="1.客户端程序"></a>1.客户端程序</h3><p>客户端有两个线程<br>一个线程由主类SocketClient实现向服务器发送消息<br>一个线程由内部类readLineThread实现监听服务器发来的消息并显示  </p>
<pre><code class="lang-java">import java.io.BufferedReader;
import java.io.InputStreamReader;
import java.io.PrintWriter;
import java.net.Socket;

public class SocketClient extends Socket{

    private static final String SERVER_IP = &quot;127.0.0.1&quot;;
    private static final int SERVER_PORT = 2017;

    private Socket client;
    private PrintWriter out;
    private BufferedReader in;

    /**
     * 与服务器连接，并输入发送消息
     */
    public SocketClient() throws Exception{
        super(SERVER_IP, SERVER_PORT);
        client = this;
        out = new PrintWriter(this.getOutputStream(), true);
        in = new BufferedReader(new InputStreamReader(this.getInputStream()));
        new readLineThread();

        while(true){
            in = new BufferedReader(new InputStreamReader(System.in));
            String input = in.readLine();
            out.println(input);
        }
    }

    /**
     * 用于监听服务器端向客户端发送消息线程类
     */
    class readLineThread extends Thread{

        private BufferedReader buff;
        public readLineThread(){
            try {
                buff = new BufferedReader(new InputStreamReader(client.getInputStream()));
                start();
            } catch (Exception e) {
            }
        }

        @Override
        public void run() {
            try {
                while(true){
                    String result = buff.readLine();
                    if(&quot;byeClient&quot;.equals(result)){//客户端申请退出，服务端返回确认退出
                        break;
                    }else{//输出服务端发送消息
                        System.out.println(result);
                    }
                }
                in.close();
                out.close();
                client.close();
            } catch (Exception e) {
            }
        }
    }

    public static void main(String[] args) {
        try {
            new SocketClient();//启动客户端
        } catch (Exception e) {
        }
    }
}
</code></pre>
<h3 id="2-服务器程序"><a href="#2-服务器程序" class="headerlink" title="2.服务器程序"></a>2.服务器程序</h3><p>服务器由三个类实现<br>主类Server监听客户端请求，并启用线程处理请求<br>内部类PrintOutThread监听输出消息请求，将消息发送到所有客户端<br>内部类ServerThread提供与每一个用户的连接  </p>
<pre><code class="lang-java">import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.io.PrintWriter;
import java.net.ServerSocket;
import java.net.Socket;
import java.util.ArrayList;
import java.util.LinkedList;
import java.util.List;

public class Server extends ServerSocket {

    private static final int SERVER_PORT = 2017;

    private static boolean isPrint = false;// 是否输出消息标志
    private static List user_list = new ArrayList();// 登录用户集合
    private static List&lt;ServerThread&gt; thread_list = new ArrayList&lt;ServerThread&gt;();// 服务器已启用线程集合
    private static LinkedList message_list = new LinkedList();// 存放消息队列

    /**
     * 创建服务端Socket,创建向客户端发送消息线程,监听客户端请求并处理
     */
    public Server() throws IOException {
        super(SERVER_PORT);// 创建ServerSocket
        new PrintOutThread();// 创建向客户端发送消息线程

        try {
            while (true) {// 监听客户端请求，启用一个线程处理
                Socket socket = accept();
                new ServerThread(socket);
            }
        } catch (Exception e) {
        } finally {
            close();
        }
    }

    /**
     * 监听是否有输出消息请求线程类,向客户端发送消息
     */
    class PrintOutThread extends Thread {

        public PrintOutThread() {
            start();
        }

        @Override
        public void run() {
            while (true) {
                //没有打印这句，if里面的语句不会执行，可能是多线程访问isPrint造成的
                System.out.println(&quot;运行中。。。&quot;+isPrint);
                if (isPrint) {// 将缓存在队列中的消息按顺序发送到各客户端,并从队列中清除。
                    String message = (String) message_list.getFirst();
                    for (ServerThread thread : thread_list) {
                        thread.sendMessage(message);
                    }
                    message_list.removeFirst();
                    isPrint = message_list.size() &gt; 0 ? true : false;
                }
            }
        }
    }

    /**
     * 服务器线程类
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    class ServerThread extends Thread {
        private Socket client;
        private PrintWriter out;
        private BufferedReader in;
        private String name;

        public ServerThread(Socket s) throws IOException {
            client = s;
            out = new PrintWriter(client.getOutputStream(), true);
            in = new BufferedReader(new InputStreamReader(client.getInputStream()));
            //in.readLine();
            out.println(&quot;成功连上聊天室,请输入你的名字：&quot;);
            start();
        }

        @Override
        public void run() {
            try {
                int flag = 0;
                String line = in.readLine();
                while (true) {
                    // 查看在线用户列表
                    if (&quot;showuser&quot;.equals(line)) {
                        out.println(this.listOnlineUsers());
                    }
                    if(&quot;bye&quot;.equals(line)){
                        out.println(&quot;bye&quot;);
                    break;}
                    // 第一次进入，保存名字
                    if (flag++ == 0) {
                        name = line;
                        user_list.add(name);
                        thread_list.add(this);
                        out.println(name + &quot;你好,可以开始聊天了...&quot;);
                        this.pushMessage(&quot;Client&lt;&quot; + name + &quot;&gt;进入聊天室...&quot;);
                    } else {
                        this.pushMessage(&quot;Client&lt;&quot; + name + &quot;&gt; say : &quot; + line);
                    }
                    line = in.readLine();

                }
                out.println(&quot;byeClient&quot;);
            } catch (Exception e) {
                e.printStackTrace();
            } finally {// 用户退出聊天室
                try {
                    client.close();
                } catch (IOException e) {
                    e.printStackTrace();
                }
                thread_list.remove(this);
                user_list.remove(name);
                pushMessage(&quot;Client&lt;&quot; + name + &quot;&gt;退出了聊天室&quot;);
            }
        }

        // 放入消息队列末尾，准备发送给客户端
        private void pushMessage(String msg) {
            message_list.addLast(msg);
            isPrint = true;
        }

        // 向客户端发送一条消息
        private void sendMessage(String msg) {
            out.println(msg);
        }

        // 统计在线用户列表
        private String listOnlineUsers() {
            String s = &quot;--- 在线用户列表 ---\015\012&quot;;
            for (int i = 0; i &lt; user_list.size(); i++) {
                s += &quot;[&quot; + user_list.get(i) + &quot;]\015\012&quot;;
            }
            s += &quot;--------------------&quot;;
            return s;
        }
    }

    public static void main(String[] args) throws IOException {
        new Server();// 启动服务端
    }
}
</code></pre>
<p>这里好像出现了多线程问题</p>
<pre><code class="lang-java">@Override
public void run() {
    while (true) {
        //没有打印下面这句，if里面的语句不会执行，可能是这个线程一直访问isPrint,改变它的线程不能访问到它造成的
        System.out.println(&quot;运行中。。。&quot;+isPrint);
        if (isPrint) {// 将缓存在队列中的消息按顺序发送到各客户端，并从队列中清除。
            String message = (String) message_list.getFirst();
            for (ServerThread thread : thread_list) {
                thread.sendMessage(message);
            }
            message_list.removeFirst();
            isPrint = message_list.size() &gt; 0 ? true : false;
        }
    }
}
</code></pre>
</div><div class="p-copyright"><blockquote><div class="p-copyright-author"><span class="p-copyright-key">本文作者：</span><span class="p-copytight-value"><a href="mailto:litreily@163.com">Frey</a></span></div><div class="p-copyright-link"><span class="p-copyright-key">本文链接：</span><span class="p-copytight-value"><a href="/2017/JAVA套接字之TCP实现聊天室/">https://www.vhcffh.com/2017/JAVA套接字之TCP实现聊天室/</a></span></div><div class="p-copyright-note"><span class="p-copyright-key">版权声明：</span><span class="p-copytight-value">本博客所有文章除特殊声明外，均采用<a rel="nofollow" target="_blank" href="https://creativecommons.org/licenses/by-nc/4.0/"> CC BY-NC 4.0 </a>许可协议。转载请注明出处 <a href="https://www.vhcffh.com">Frey的博客</a>！</span></div></blockquote></div></article><div class="p-info box"><span class="p-tags"><i class="fa fa-tags"></i><a href="/tags/网络编程/">网络编程</a><a href="/tags/TCP/">TCP</a><a href="/tags/聊天室/">聊天室</a></span></div></div><section class="p-ext"><div class="l-pager l-pager-dtl box"><a class="prev" href="/2017/自己写一个Android照相机应用-2/">&lt; 自己写一个Android照相机应用-2</a><a class="next" href="/2017/涉及PyQt5的一些命令/">涉及PyQt5的一些命令 &gt;</a></div><div id="valine-comment"><style type="text/css">.v * { color: #CECECE; }
.v a { color: #0F9FB4; }
.v a:hover { color: #216C73; }
.v li { list-style: inherit; }
.v .vwrap { border: 1px solid #223441; border-radius: 0; }
.v .vwrap:hover { box-shadow: 0 0 6px 1px #223441; }
.v .vbtn { border-radius: 0; color: #cecece; background: none; }
.v .vlist .vcard .vh { border-bottom-color: #293D4E; }
.v .vwrap .vheader .vinput { border-bottom-color: #223441; }
.v .vwrap .vheader .vinput:focus { border-bottom-color: #339EB4; }
.v code, .v pre,.v .vlist .vcard .vhead .vsys { background: #203240; }
.v .vlist .vcard .vcontent.expand:before { background: linear-gradient(180deg,hsla(206,33%,19%,0),hsla(206,33%,19%,.9)); }
.v .vlist .vcard .vcontent.expand:after { background: hsla(206,33%,19%,.9); }</style><div id="vcomment"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script><script>var notify = 'false' == true ? true : false;
var verify = 'false' == true ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'IYkIGtHfOiXLr2xvQwvikmRk-gzGzoHsz',
  appKey:'Hw0Ta8iM7YvN1RscFx37Dwh1',
  placeholder:'ヾﾉ≧∀≦)o Come on, say something...',
  avatar:'',
  guest_info:guest_info,
  pageSize:'10'
})</script></div></section><footer><p>Copyright © 2016 - 2019 <a href="/." rel="nofollow">Frey's blog</a> | <strong><a rel="nofollow" target="_blank" href="https://creativecommons.org/licenses/by-nc/4.0/">CC BY-NC 4.0</a></strong><br><span id="busuanzi_container_site_uv"><i class="fa fa-user"></i><span id="busuanzi_value_site_uv"></span></span> <span id="busuanzi_container_site_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_site_pv"></span></span> | Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a>Theme with<a rel="nofollow" target="_blank" href="https://github.com/litreily/snark-hexo"> snark.</a></p></footer></div></div></div><script type="text/javascript" src="/plugins/prettify/prettify.js"></script><script type="text/javascript" src="/js/search.js"></script><script type="text/javascript" src="/js/top.js"></script><script type="text/javascript" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
    search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.1" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"></body></html>