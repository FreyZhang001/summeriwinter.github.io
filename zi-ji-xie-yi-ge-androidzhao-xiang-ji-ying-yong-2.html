<!DOCTYPE html>
<html lang="zh-CN">
<head>
        <title>Frey's blog : 自己写一个Android照相机应用-2</title>
        <meta charset="utf-8" />
        <link rel="stylesheet" href="https://www.vhcffh.com/theme/css/main.css" type="text/css" />
        <link href="https://www.vhcffh.com/" type="application/atom+xml" rel="alternate" title="Frey's blog ATOM Feed" />

        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="https://www.vhcffh.com/css/ie.css"/>
                <script src="https://www.vhcffh.com/js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="https://www.vhcffh.com/css/ie6.css"/><![endif]-->
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-111205240-3"></script>
    <script>
        gtag('config', 'UA-111205240-3');
    </script>

</head>

<body>
        
<header>
    <h1><a href="https://www.vhcffh.com/zi-ji-xie-yi-ge-androidzhao-xiang-ji-ying-yong-2.html" id="page-title">自己写一个Android照相机应用-2</a></h1>
    <span id="sitename"><a href="https://www.vhcffh.com" id="site-title">Frey's blog </a> &sdot;</span>
<time datetime="2017-08-19T10:01:00+08:00">2017-08-19</time></header>
<article>
    <p>首先是要创建camera的生命周期  </p>
<div class="highlight"><pre><span></span><span class="n">getCamera</span><span class="o">();</span><span class="c1">//获取Camera对象</span>
<span class="n">setStartPreview</span><span class="o">(</span><span class="n">Camera</span> <span class="n">camera</span><span class="o">,</span><span class="n">SurfaceHolder</span> <span class="n">holder</span><span class="o">);</span><span class="c1">//预览相机内容</span>
<span class="n">releaseCamera</span><span class="o">();</span><span class="c1">//释放相机资源</span>
</pre></div>


<p>activity生命周期与camera绑定  </p>
<div class="highlight"><pre><span></span><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onResume</span><span class="o">()</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">.</span><span class="na">onResume</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">mCamera</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mCamera</span> <span class="o">=</span> <span class="n">getCamera</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mHolder</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">setStartPreview</span><span class="o">(</span><span class="n">mCamera</span><span class="o">,</span><span class="n">mHolder</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onPause</span><span class="o">()</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">.</span><span class="na">onPause</span><span class="o">();</span>
    <span class="n">releaseCamera</span><span class="o">();</span>
<span class="o">}</span>
</pre></div>


<p>camera与surfaceview绑定</p>
<div class="highlight"><pre><span></span><span class="c1">//预览图像与camera绑定</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">surfaceCreated</span><span class="o">(</span><span class="n">SurfaceHolder</span> <span class="n">holder</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">setStartPreview</span><span class="o">(</span><span class="n">mCamera</span><span class="o">,</span><span class="n">mHolder</span><span class="o">);</span>
<span class="o">}</span>

<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">surfaceChanged</span><span class="o">(</span><span class="n">SurfaceHolder</span> <span class="n">holder</span><span class="o">,</span> <span class="kt">int</span> <span class="n">format</span><span class="o">,</span> <span class="kt">int</span> <span class="n">width</span><span class="o">,</span> <span class="kt">int</span> <span class="n">height</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">mCamera</span><span class="o">.</span><span class="na">stopPreview</span><span class="o">();</span>
    <span class="n">setStartPreview</span><span class="o">(</span><span class="n">mCamera</span><span class="o">,</span><span class="n">mHolder</span><span class="o">);</span>
<span class="o">}</span>

<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">surfaceDestroyed</span><span class="o">(</span><span class="n">SurfaceHolder</span> <span class="n">holder</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">releaseCamera</span><span class="o">();</span>
<span class="o">}</span>
</pre></div>


<p>声明相机使用权限  </p>
<div class="highlight"><pre><span></span><span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">&quot;android.permission.CAMERA&quot;</span><span class="err">&lt;/uses-permission</span><span class="nt">&gt;</span>
</pre></div>


<p>实现照相，通过回调将照片数据保存到文件，并将文件路径传递到其它activity(ResultAty)</p>
<div class="highlight"><pre><span></span><span class="kd">private</span> <span class="n">Camera</span><span class="o">.</span><span class="na">PictureCallback</span> <span class="n">mPictureCallback</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Camera</span><span class="o">.</span><span class="na">PictureCallback</span><span class="o">()</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onPictureTaken</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">data</span><span class="o">,</span> <span class="n">Camera</span> <span class="n">camera</span><span class="o">)</span> <span class="o">{</span><span class="c1">//data中存储照片的全部信息</span>
        <span class="n">File</span> <span class="n">tempFile</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="s">&quot;/sdacrd/temp.png&quot;</span><span class="o">);</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">FileOutputStream</span> <span class="n">fos</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileOutputStream</span><span class="o">(</span><span class="n">tempFile</span><span class="o">);</span>
            <span class="n">fos</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">data</span><span class="o">);</span>
            <span class="n">fos</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="n">Intent</span> <span class="n">intent</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Intent</span><span class="o">(</span><span class="n">CustomCamera</span><span class="o">.</span><span class="na">this</span><span class="o">,</span><span class="n">ResultAty</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
            <span class="n">intent</span><span class="o">.</span><span class="na">putExtra</span><span class="o">(</span><span class="s">&quot;picPath&quot;</span><span class="o">,</span><span class="n">tempFile</span><span class="o">.</span><span class="na">getAbsolutePath</span><span class="o">());</span>
            <span class="n">startActivity</span><span class="o">(</span><span class="n">intent</span><span class="o">);</span>
            <span class="n">CustomCamera</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">finish</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">FileNotFoundException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">};</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">capture</span><span class="o">(</span><span class="n">View</span> <span class="n">view</span><span class="o">){</span>
    <span class="n">Camera</span><span class="o">.</span><span class="na">Parameters</span> <span class="n">parameters</span> <span class="o">=</span> <span class="n">mCamera</span><span class="o">.</span><span class="na">getParameters</span><span class="o">();</span>
    <span class="n">parameters</span><span class="o">.</span><span class="na">setPictureFormat</span><span class="o">(</span><span class="n">ImageFormat</span><span class="o">.</span><span class="na">JPEG</span><span class="o">);</span><span class="c1">//设置拍照格式jpg格式</span>
    <span class="n">parameters</span><span class="o">.</span><span class="na">setPictureSize</span><span class="o">(</span><span class="mi">800</span><span class="o">,</span><span class="mi">400</span><span class="o">);</span><span class="c1">//设置照片大小</span>
    <span class="n">parameters</span><span class="o">.</span><span class="na">setFocusMode</span><span class="o">(</span><span class="n">Camera</span><span class="o">.</span><span class="na">Parameters</span><span class="o">.</span><span class="na">FOCUS_MODE_AUTO</span><span class="o">);</span><span class="c1">//设置自动对焦</span>
    <span class="n">mCamera</span><span class="o">.</span><span class="na">autoFocus</span><span class="o">(</span><span class="k">new</span> <span class="n">Camera</span><span class="o">.</span><span class="na">AutoFocusCallback</span><span class="o">()</span> <span class="o">{</span>  <span class="c1">//回调，对焦最清晰时拍照</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onAutoFocus</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">success</span><span class="o">,</span> <span class="n">Camera</span> <span class="n">camera</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">success</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">mCamera</span><span class="o">.</span><span class="na">takePicture</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span><span class="kc">null</span><span class="o">,</span><span class="n">mPictureCallback</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="o">});</span>

<span class="o">}</span>
</pre></div>
</article>



</body>
</html>